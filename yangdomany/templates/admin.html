<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .admin-header h1 {
            color: #6b46c1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
            color: #6b46c1;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .admin-tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .admin-tab-btn:hover {
            color: #6b46c1;
        }

        .admin-tab-btn.active {
            color: #6b46c1;
            border-bottom-color: #6b46c1;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .admin-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th {
            background: #f8f8f8;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        .admin-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .admin-table tr:hover {
            background: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-approve {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-reject {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-delete {
            padding: 6px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-ban {
            padding: 6px 12px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-unban {
            padding: 6px 12px;
            background: #4ecdc4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><a href="/">공연 양도</a></h1>
        </div>
    </header>

    <div class="admin-container">
        <div class="admin-header">
            <h1>관리자 페이지</h1>
            <a href="/" class="auth-btn">메인으로</a>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>전체 사용자</h3>
                <div class="number" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <h3>전체 티켓</h3>
                <div class="number" id="totalTickets">0</div>
            </div>
            <div class="stat-card">
                <h3>승인 대기</h3>
                <div class="number" id="pendingTickets">0</div>
            </div>
            <div class="stat-card">
                <h3>승인 완료</h3>
                <div class="number" id="approvedTickets">0</div>
            </div>
        </div>

        <div class="admin-tabs">
            <button class="admin-tab-btn active" onclick="showTab('pending')">승인 대기</button>
            <button class="admin-tab-btn" onclick="showTab('all')">전체 티켓</button>
            <button class="admin-tab-btn" onclick="showTab('users')">사용자 관리</button>
        </div>

        <div id="pendingTab" class="admin-tab-content active">
            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>공연명</th>
                            <th>날짜/시간</th>
                            <th>좌석</th>
                            <th>가격</th>
                            <th>판매자</th>
                            <th>등록일</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="allTab" class="admin-tab-content">
            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>공연명</th>
                            <th>날짜/시간</th>
                            <th>좌석</th>
                            <th>가격</th>
                            <th>판매자</th>
                            <th>상태</th>
                            <th>등록일</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="allTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="usersTab" class="admin-tab-content">
            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>이메일</th>
                            <th>닉네임</th>
                            <th>제공자</th>
                            <th>휴대폰</th>
                            <th>평점</th>
                            <th>가입일</th>
                            <th>상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 거부 사유 모달 -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRejectModal()">&times;</span>
            <h3>거부 사유 입력</h3>
            <form id="rejectForm">
                <input type="hidden" id="rejectTicketId">
                <div class="form-group">
                    <label>거부 사유</label>
                    <textarea id="rejectReason" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required></textarea>
                </div>
                <button type="submit" class="auth-btn">거부하기</button>
            </form>
        </div>
    </div>

    <!-- 정지 사유 모달 -->
    <div id="banModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBanModal()">&times;</span>
            <h3>사용자 정지</h3>
            <form id="banForm">
                <input type="hidden" id="banUserId">
                <div class="form-group">
                    <label>정지 사유</label>
                    <textarea id="banReason" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required></textarea>
                </div>
                <button type="submit" class="auth-btn">정지하기</button>
            </form>
        </div>
    </div>

    <script>
        async function loadStats() {
            const res = await fetch('/api/admin/stats');
            const data = await res.json();
            
            if (data.success) {
                document.getElementById('totalUsers').textContent = data.stats.total_users;
                document.getElementById('totalTickets').textContent = data.stats.total_tickets;
                document.getElementById('pendingTickets').textContent = data.stats.pending_tickets;
                document.getElementById('approvedTickets').textContent = data.stats.approved_tickets;
            }
        }

        async function loadPendingTickets() {
            const res = await fetch('/api/admin/pending-tickets');
            const data = await res.json();
            
            if (data.success) {
                const tbody = document.getElementById('pendingTableBody');
                
                if (data.tickets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="no-data">승인 대기 중인 티켓이 없습니다.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.tickets.map(ticket => `
                    <tr>
                        <td>${ticket._id}</td>
                        <td>${ticket.show_title}</td>
                        <td>${ticket.date} ${ticket.time}</td>
                        <td>${ticket.seat}</td>
                        <td>${ticket.price.toLocaleString()}원</td>
                        <td>${ticket.seller}</td>
                        <td>${ticket.created_at}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-approve" onclick="approveTicket(${ticket._id})">승인</button>
                                <button class="btn-reject" onclick="openRejectModal(${ticket._id})">거부</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function loadAllTickets() {
            const res = await fetch('/api/admin/all-tickets');
            const data = await res.json();
            
            if (data.success) {
                const tbody = document.getElementById('allTableBody');
                
                if (data.tickets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="no-data">티켓이 없습니다.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.tickets.map(ticket => {
                    let statusBadge = '';
                    if (ticket.status === 'pending') {
                        statusBadge = '<span class="status-badge status-pending">대기</span>';
                    } else if (ticket.status === 'approved') {
                        statusBadge = '<span class="status-badge status-approved">승인</span>';
                    } else if (ticket.status === 'rejected') {
                        statusBadge = '<span class="status-badge status-rejected">거부</span>';
                    }
                    
                    return `
                        <tr>
                            <td>${ticket._id}</td>
                            <td>${ticket.show_title}</td>
                            <td>${ticket.date} ${ticket.time}</td>
                            <td>${ticket.seat}</td>
                            <td>${ticket.price.toLocaleString()}원</td>
                            <td>${ticket.seller}</td>
                            <td>${statusBadge}</td>
                            <td>${ticket.created_at}</td>
                            <td>
                                <button class="btn-delete" onclick="deleteTicket(${ticket._id})">삭제</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        async function loadUsers() {
            const res = await fetch('/api/admin/users');
            const data = await res.json();
            
            if (data.success) {
                const tbody = document.getElementById('usersTableBody');
                
                tbody.innerHTML = data.users.map(user => {
                    const isBanned = user.banned || false;
                    
                    return `
                        <tr>
                            <td>${user.email}</td>
                            <td>${user.nickname}</td>
                            <td>${user.provider || 'email'}</td>
                            <td>${user.phone || '-'}</td>
                            <td>${user.rating || 5.0}</td>
                            <td>${user.created_at || '-'}</td>
                            <td>${isBanned ? '<span class="status-badge status-rejected">정지</span>' : '<span class="status-badge status-approved">정상</span>'}</td>
                            <td>
                                ${isBanned 
                                    ? `<button class="btn-unban" onclick="unbanUser('${user._id}')">해제</button>`
                                    : `<button class="btn-ban" onclick="openBanModal('${user._id}')">정지</button>`
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        async function approveTicket(ticketId) {
            if (!confirm('이 티켓을 승인하시겠습니까?')) return;
            
            const res = await fetch(`/api/admin/approve-ticket/${ticketId}`, {
                method: 'POST'
            });
            const data = await res.json();
            
            if (data.success) {
                alert(data.message);
                loadStats();
                loadPendingTickets();
                loadAllTickets();
            }
        }

        function openRejectModal(ticketId) {
            document.getElementById('rejectTicketId').value = ticketId;
            document.getElementById('rejectModal').style.display = 'block';
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
            document.getElementById('rejectForm').reset();
        }

        document.getElementById('rejectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const ticketId = document.getElementById('rejectTicketId').value;
            const reason = document.getElementById('rejectReason').value;
            
            const res = await fetch(`/api/admin/reject-ticket/${ticketId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            });
            const data = await res.json();
            
            if (data.success) {
                alert(data.message);
                closeRejectModal();
                loadStats();
                loadPendingTickets();
                loadAllTickets();
            }
        });

        async function deleteTicket(ticketId) {
            if (!confirm('이 티켓을 삭제하시겠습니까?')) return;
            
            const res = await fetch(`/api/admin/delete-ticket/${ticketId}`, {
                method: 'DELETE'
            });
            const data = await res.json();
            
            if (data.success) {
                alert(data.message);
                loadStats();
                loadPendingTickets();
                loadAllTickets();
            }
        }

        function openBanModal(userId) {
            document.getElementById('banUserId').value = userId;
            document.getElementById('banModal').style.display = 'block';
        }

        function closeBanModal() {
            document.getElementById('banModal').style.display = 'none';
            document.getElementById('banForm').reset();
        }

        document.getElementById('banForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('banUserId').value;
            const reason = document.getElementById('banReason').value;
            
            const res = await fetch(`/api/admin/ban-user/${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            });
            const data = await res.json();
            
            if (data.success) {
                alert(data.message);
                closeBanModal();
                loadUsers();
            }
        });

        async function unbanUser(userId) {
            if (!confirm('이 사용자의 정지를 해제하시겠습니까?')) return;
            
            const res = await fetch(`/api/admin/unban-user/${userId}`, {
                method: 'POST'
            });
            const data = await res.json();
            
            if (data.success) {
                alert(data.message);
                loadUsers();
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'pending') {
                document.getElementById('pendingTab').classList.add('active');
                loadPendingTickets();
            } else if (tabName === 'all') {
                document.getElementById('allTab').classList.add('active');
                loadAllTickets();
            } else if (tabName === 'users') {
                document.getElementById('usersTab').classList.add('active');
                loadUsers();
            }
        }

        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadPendingTickets();
        });
    </script>
</body>
<footer style="background: #f8f8f8; padding: 30px 20px; margin-top: 50px; text-align: center;">
    <div class="container">
        <p style="color: #666; margin-bottom: 10px;">양도마니 - 정가 티켓 양도 플랫폼</p>
        <div style="margin-bottom: 15px;">
            <a href="/privacy" style="color: #6b46c1; margin: 0 10px;">개인정보처리방침</a>
            <a href="/terms" style="color: #6b46c1; margin: 0 10px;">이용약관</a>
        </div>
        
        <!-- 후원 버튼 -->
        <div class="support-box" style="margin: 20px auto; max-width: 400px;">
            <p style="margin-bottom: 10px;">서비스가 도움되셨나요?</p>
            <a href="https://toss.me/양도마니" target="_blank" 
               style="display: inline-block; padding: 10px 20px; background: #0064FF; color: white; border-radius: 6px; text-decoration: none;">
                ☕ 커피 후원하기
            </a>
        </div>
        
        <p style="color: #999; font-size: 13px; margin-top: 15px;">
            문의: psunyong2@gmail.com
        </p>
    </div>
</footer>
</html>