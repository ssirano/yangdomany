<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–‘ë„ë§ˆë‹ˆ - ì •ê°€ í‹°ì¼“ ì–‘ë„ í”Œë«í¼</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1><a href="/">ì–‘ë„ë§ˆë‹ˆ</a></h1>
            <div class="header-right">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ë°°ìš°/ì‘í’ˆëª… ê²€ìƒ‰">
                    <button onclick="handleSearch()">ê²€ìƒ‰</button>
                </div>
                <div class="auth-buttons">
                    <a href="/login" class="login-btn">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>
    </header>

    <nav>
        <div class="container">
            <a href="/">ë©”ì¸</a>
            <a href="/transfer">ì–‘ë„í•˜ê¸°</a>
            <a href="/mypage">ë§ˆì´í˜ì´ì§€</a>
            <a href="/admin" id="adminMenu" style="display: none; color: #ff6b6b; font-weight: 600;">ê´€ë¦¬ì</a>
        </div>
    </nav>

    <main class="container">
        <!-- ë°•ìŠ¤ì˜¤í”¼ìŠ¤ TOP 10 (ìë™ ì „í™˜) -->
        {% if boxoffice_plays or boxoffice_musicals %}
        <section class="boxoffice-section">
            <div class="section-header">
                <h2>
                    ğŸ† ì´ë‹¬ì˜ ë°•ìŠ¤ì˜¤í”¼ìŠ¤ TOP 10
                    <span class="category-indicator" id="categoryIndicator">ì—°ê·¹</span>
                </h2>
                <div class="header-right-info">
                    {% if update_date %}
                    <p class="update-info">{{ update_date.strftime('%Y.%m.%d') }} ê¸°ì¤€</p>
                    {% endif %}
                    <div class="auto-switch-indicator">
                        <span class="switch-dot"></span>
                        <span class="switch-text">10ì´ˆë§ˆë‹¤ ìë™ ì „í™˜</span>
                    </div>
                </div>
            </div>
            
            <!-- ì—°ê·¹ TOP 10 -->
            <div class="boxoffice-grid" id="playsGrid" style="display: grid;">
                {% for show in boxoffice_plays %}
                <div class="boxoffice-card" onclick="searchShow('{{ show.title }}')">
                    <div class="rank-badge rank-{{ show.boxoffice_rank }}">
                        {{ show.boxoffice_rank }}
                    </div>
                    
                    <div class="poster-wrapper">
                        {% if show.poster %}
                            <img src="{{ show.poster }}" alt="{{ show.title }}" onerror="this.parentElement.innerHTML='<div class=\'poster-placeholder\'><span>{{ show.title[0] }}</span></div>'">
                        {% else %}
                            <div class="poster-placeholder">
                                <span>{{ show.title[0] }}</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="boxoffice-info">
                        <span class="category-badge ì—°ê·¹">ì—°ê·¹</span>
                        <h3>{{ show.title }}</h3>
                        <p class="venue">{{ show.venue }}</p>
                        
                        {% if show.prices %}
                            {% set price_list = show.prices.values() | list %}
                            {% if price_list %}
                                <div class="price-info">
                                    <span class="price-tag">{{ (price_list | min) | format_number }}ì›~</span>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- ë®¤ì§€ì»¬ TOP 10 -->
            <div class="boxoffice-grid" id="musicalsGrid" style="display: none;">
                {% for show in boxoffice_musicals %}
                <div class="boxoffice-card" onclick="searchShow('{{ show.title }}')">
                    <div class="rank-badge rank-{{ show.boxoffice_rank }}">
                        {{ show.boxoffice_rank }}
                    </div>
                    
                    <div class="poster-wrapper">
                        {% if show.poster %}
                            <img src="{{ show.poster }}" alt="{{ show.title }}" onerror="this.parentElement.innerHTML='<div class=\'poster-placeholder\'><span>{{ show.title[0] }}</span></div>'">
                        {% else %}
                            <div class="poster-placeholder">
                                <span>{{ show.title[0] }}</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="boxoffice-info">
                        <span class="category-badge ë®¤ì§€ì»¬">ë®¤ì§€ì»¬</span>
                        <h3>{{ show.title }}</h3>
                        <p class="venue">{{ show.venue }}</p>
                        
                        {% if show.prices %}
                            {% set price_list = show.prices.values() | list %}
                            {% if price_list %}
                                <div class="price-info">
                                    <span class="price-tag">{{ (price_list | min) | format_number }}ì›~</span>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- ì¸ê¸° ê²€ìƒ‰ ë°°ìš° -->
        {% if actors %}
        <section class="actors-section">
            <h2>ì¸ê¸° ê²€ìƒ‰ ë°°ìš°</h2>
            <div class="actor-grid">
                {% for actor in actors %}
                <div class="actor-card" onclick="searchActor('{{ actor.name }}')">
                    {% if actor.image and actor.image.startswith('http') %}
                        <img src="{{ actor.image }}" alt="{{ actor.name }}" onerror="this.parentElement.innerHTML='<div class=\'actor-placeholder\'><span>{{ actor.name[0] }}</span></div>'">
                    {% else %}
                        <div class="actor-placeholder">
                            <span>{{ actor.name[0] }}</span>
                        </div>
                    {% endif %}
                    <div class="actor-info">
                        <span class="actor-name">{{ actor.name }}</span>
                        <span class="search-count">{{ actor.count }}íšŒ</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </main>

    <footer style="background: #f8f8f8; padding: 40px 20px; margin-top: 60px;">
        <div class="container" style="max-width: 1200px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="color: #6b46c1; font-size: 20px; margin-bottom: 10px;">ì–‘ë„ë§ˆë‹ˆ</h3>
                <p style="color: #666; font-size: 14px;">ì •ê°€ í‹°ì¼“ ì–‘ë„ í”Œë«í¼</p>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <a href="/privacy" style="color: #6b46c1; text-decoration: none; font-size: 14px;">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
                <a href="/terms" style="color: #6b46c1; text-decoration: none; font-size: 14px;">ì´ìš©ì•½ê´€</a>
                <a href="/support" style="color: #ff6b6b; text-decoration: none; font-size: 14px; font-weight: 600;">â˜• í›„ì›í•˜ê¸°</a>
            </div>
            
            <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <p style="color: #999; font-size: 13px; margin: 5px 0;">
                    ë¬¸ì˜: psunyong2@gmail.com
                </p>
                <p style="color: #ccc; font-size: 12px; margin-top: 10px;">
                    Â© 2025 ì–‘ë„ë§ˆë‹ˆ. All rights reserved.
                </p>
            </div>
        </div>
    </footer>

    <script>
        // ë°•ìŠ¤ì˜¤í”¼ìŠ¤ ìë™ ì „í™˜
        let currentCategory = 'plays';
        let switchInterval;

        function switchBoxoffice() {
            const playsGrid = document.getElementById('playsGrid');
            const musicalsGrid = document.getElementById('musicalsGrid');
            const indicator = document.getElementById('categoryIndicator');
            
            if (currentCategory === 'plays') {
                // ì—°ê·¹ â†’ ë®¤ì§€ì»¬
                playsGrid.style.display = 'none';
                musicalsGrid.style.display = 'grid';
                indicator.textContent = 'ë®¤ì§€ì»¬';
                indicator.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a6f)';
                currentCategory = 'musicals';
            } else {
                // ë®¤ì§€ì»¬ â†’ ì—°ê·¹
                musicalsGrid.style.display = 'none';
                playsGrid.style.display = 'grid';
                indicator.textContent = 'ì—°ê·¹';
                indicator.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                currentCategory = 'plays';
            }
        }

        // 10ì´ˆë§ˆë‹¤ ìë™ ì „í™˜
        function startAutoSwitch() {
            switchInterval = setInterval(switchBoxoffice, 10000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘
        document.addEventListener('DOMContentLoaded', function() {
            startAutoSwitch();
        });

        // íƒ­ì„ ë– ë‚  ë•Œ ë©ˆì¶”ê³ , ëŒì•„ì˜¤ë©´ ì¬ì‹œì‘
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(switchInterval);
            } else {
                startAutoSwitch();
            }
        });

        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/me');
                
                if (response.status === 401) {
                    return;
                }
                
                const data = await response.json();
                
                const authButtons = document.querySelector('.auth-buttons');
                if (data.success && data.user) {
                    authButtons.innerHTML = `
                        <span class="user-nickname">${data.user.nickname}ë‹˜</span>
                        <button onclick="handleLogout()" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
                    `;
                    
                    checkAdminMenu();
                }
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        async function checkAdminMenu() {
            try {
                const response = await fetch('/api/is-admin');
                const data = await response.json();
                
                if (data.is_admin) {
                    const adminMenu = document.getElementById('adminMenu');
                    if (adminMenu) {
                        adminMenu.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('ê´€ë¦¬ì í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        async function handleLogout() {
            try {
                const response = await fetch('/api/logout', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.reload();
                }
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            }
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                window.location.href = `/search?q=${encodeURIComponent(query)}`;
            }
        }

        function searchShow(title) {
            window.location.href = `/search?q=${encodeURIComponent(title)}`;
        }

        function searchActor(name) {
            fetch(`/api/actor-search/${encodeURIComponent(name)}`, { 
                method: 'POST' 
            }).catch(err => console.log('Count update failed:', err));
            
            window.location.href = `/search?q=${encodeURIComponent(name)}`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                });
            }
        });
    </script>
</body>
</html>